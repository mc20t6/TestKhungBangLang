<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lĩnh vực Kinh tế - Hệ thống dữ liệu xã Bằng Lang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-house-door-fill text-warning"></i>
                <span class="ms-2 fw-bold">DỮ LIỆU SỐ XÃ BẰNG LANG</span>
            </a>
            <div class="ms-auto">
                <a href="../index.html" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="mb-4">
            <h2 class="mb-1">
                <i class="bi bi-graph-up-arrow text-success"></i> 
                Lĩnh vực Kinh tế
            </h2>
            <p class="text-muted">Quản lý và theo dõi 18 chỉ tiêu về sản xuất, thương mại và ngân sách</p>
        </div>

        <!-- Filter bar -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Thời gian</label>
                        <input type="month" class="form-control" id="timeFilter">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Đơn vị</label>
                        <select class="form-select" id="donViFilter">
                            <!-- Điền bằng JS -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Nhóm chỉ tiêu</label>
                        <select class="form-select" id="groupFilter">
                            <option value="">Tất cả</option>
                            <option value="nong-lam-ngu">Nông - Lâm - Ngư nghiệp</option>
                            <option value="cong-nghiep">Công nghiệp - TTCN - Xây dựng</option>
                            <option value="thuong-mai">Thương mại - Dịch vụ</option>
                            <option value="tai-chinh">Tài chính - Ngân sách</option>
                            <option value="chuong-trinh">Chương trình, Dự án</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="moduleView.loadData()">
                            <i class="bi bi-search"></i> Xem dữ liệu
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row g-3 mb-4" id="statsOverview">
            <!-- Điền bằng JS -->
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="viewTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tableView">
                    <i class="bi bi-table"></i> Bảng dữ liệu
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartView">
                    <i class="bi bi-graph-up"></i> Biểu đồ
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#compareView">
                    <i class="bi bi-arrows-angle-expand"></i> So sánh
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Table View -->
            <div class="tab-pane fade show active" id="tableView">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Dữ liệu chi tiết</h5>
                    </div>
                    <div class="card-body">
                        <div id="dataTable">
                            <p class="text-muted">Vui lòng chọn thời gian để xem dữ liệu</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart View -->
            <div class="tab-pane fade" id="chartView">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Biểu đồ xu hướng</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Compare View -->
            <div class="tab-pane fade" id="compareView">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">So sánh theo thời gian</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="compareChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/data-config.js"></script>
    <script src="../assets/js/data-manager.js"></script>
    
    <script>
        class ModuleView {
            constructor(sectorKey) {
                this.sectorKey = sectorKey;
                this.sector = DATA_CONFIG[sectorKey];
                this.currentMonth = new Date().getMonth() + 1;
                this.currentYear = new Date().getFullYear();
                this.currentDonVi = 'toan-xa';
                
                this.init();
            }

            init() {
                this.populateDonViSelect();
                this.setCurrentMonth();
                this.loadStatsOverview();
                this.loadData();
            }

            populateDonViSelect() {
                const select = document.getElementById('donViFilter');
                select.innerHTML = DON_VI.map(dv => 
                    `<option value="${dv.id}">${dv.name}</option>`
                ).join('');
                
                select.addEventListener('change', (e) => {
                    this.currentDonVi = e.target.value;
                    this.loadData();
                });
            }

            setCurrentMonth() {
                const input = document.getElementById('timeFilter');
                input.value = `${this.currentYear}-${String(this.currentMonth).padStart(2, '0')}`;
                input.addEventListener('change', (e) => {
                    const [year, month] = e.target.value.split('-');
                    this.currentYear = parseInt(year);
                    this.currentMonth = parseInt(month);
                    this.loadData();
                });
            }

            loadStatsOverview() {
                // Lấy vài chỉ tiêu quan trọng để hiển thị
                const indicators = this.getAllIndicators().slice(0, 4);
                const container = document.getElementById('statsOverview');
                
                container.innerHTML = indicators.map(ind => {
                    const data = dataManager.getData(ind.id, this.currentDonVi, this.currentMonth, this.currentYear);
                    const change = dataManager.calculateChange(ind.id, this.currentDonVi, this.currentMonth, this.currentYear);
                    
                    return `
                        <div class="col-md-3">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-muted small">${ind.name}</div>
                                    <div class="h4 text-primary mt-2">
                                        ${data ? data.value : '-'} <small class="text-muted">${ind.unit}</small>
                                    </div>
                                    ${change && change.change !== null ? `
                                        <div class="small ${change.change >= 0 ? 'text-success' : 'text-danger'}">
                                            <i class="bi bi-arrow-${change.change >= 0 ? 'up' : 'down'}"></i>
                                            ${change.change >= 0 ? '+' : ''}${change.change}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getAllIndicators() {
                const all = [];
                Object.keys(this.sector.groups).forEach(groupKey => {
                    this.sector.groups[groupKey].indicators.forEach(ind => {
                        all.push({...ind, groupKey});
                    });
                });
                return all;
            }

            loadData() {
                const groupFilter = document.getElementById('groupFilter').value;
                let indicators = this.getAllIndicators();
                
                if (groupFilter) {
                    indicators = indicators.filter(ind => ind.groupKey === groupFilter);
                }

                this.renderTable(indicators);
                this.renderChart(indicators);
                this.loadStatsOverview();
            }

            renderTable(indicators) {
                const container = document.getElementById('dataTable');
                
                let html = '<div class="table-responsive"><table class="table table-hover">';
                html += `
                    <thead class="table-light">
                        <tr>
                            <th width="5%">STT</th>
                            <th width="35%">Chỉ tiêu</th>
                            <th width="15%">Nhóm</th>
                            <th width="15%">Đơn vị tính</th>
                            <th width="15%">Giá trị</th>
                            <th width="15%">So với tháng trước</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                indicators.forEach((ind, index) => {
                    const data = dataManager.getData(ind.id, this.currentDonVi, this.currentMonth, this.currentYear);
                    const change = dataManager.calculateChange(ind.id, this.currentDonVi, this.currentMonth, this.currentYear);
                    
                    html += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td class="fw-bold">${ind.name}</td>
                            <td><small>${this.sector.groups[ind.groupKey].name}</small></td>
                            <td><span class="badge bg-light text-dark">${ind.unit}</span></td>
                            <td class="text-primary fw-bold">${data ? data.value : '-'}</td>
                            <td>
                                ${change && change.change !== null ? `
                                    <span class="${change.change >= 0 ? 'text-success' : 'text-danger'}">
                                        <i class="bi bi-arrow-${change.change >= 0 ? 'up' : 'down'}"></i>
                                        ${change.change >= 0 ? '+' : ''}${change.change} (${change.percent}%)
                                    </span>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;
            }

            renderChart(indicators) {
                // Biểu đồ xu hướng (6 tháng gần nhất)
                const labels = [];
                const datasets = {};

                for (let i = 5; i >= 0; i--) {
                    let month = this.currentMonth - i;
                    let year = this.currentYear;
                    if (month <= 0) {
                        month += 12;
                        year -= 1;
                    }
                    labels.push(`${month}/${year}`);
                }

                // Lấy top 5 chỉ tiêu có dữ liệu
                const topIndicators = indicators.slice(0, 5);
                
                topIndicators.forEach(ind => {
                    datasets[ind.id] = {
                        label: ind.name,
                        data: [],
                        borderColor: this.getRandomColor(),
                        tension: 0.4
                    };

                    for (let i = 5; i >= 0; i--) {
                        let month = this.currentMonth - i;
                        let year = this.currentYear;
                        if (month <= 0) {
                            month += 12;
                            year -= 1;
                        }
                        const data = dataManager.getData(ind.id, this.currentDonVi, month, year);
                        datasets[ind.id].data.push(data ? parseFloat(data.value) : null);
                    }
                });

                const chartData = {
                    labels: labels,
                    datasets: Object.values(datasets)
                };

                // Destroy old chart if exists
                if (this.trendChart) {
                    this.trendChart.destroy();
                }

                const ctx = document.getElementById('trendChart').getContext('2d');
                this.trendChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Xu hướng 6 tháng gần nhất'
                            }
                        }
                    }
                });
            }

            getRandomColor() {
                const colors = [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
        }

        // Initialize
        let moduleView;
        document.addEventListener('DOMContentLoaded', () => {
            moduleView = new ModuleView('kinh-te');
        });
    </script>
</body>
</html>